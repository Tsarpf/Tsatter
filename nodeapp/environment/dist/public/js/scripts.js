var app=angular.module("tsatter",["ngAnimate","ui.bootstrap","akoenig.deckgrid","ngSanitize","luegg.directives","duScroll","flash","angular-images-loaded","lrInfiniteScroll","infinite-scroll"]);app.directive("tsChat",["$timeout",function(a){return{restrict:"E",templateUrl:"/partials/chat",link:function(b,c,d){b.channelName=d.channelName,a(function(){b.msgDiv=document.getElementById(d.channelName)})}}}]),app.directive("tsCardMessages",function(){var a=function(a){var b="";if(a){var c=JSON.parse(a);for(var d in c){var e=c[d];b+='<p class="discovery-message"><strong>'+e.nick+":</strong> "+cleanHTML(e.message)+"</p>"}}return b};return{restrict:"E",link:function(b,c,d){if(d.messages){var e=a(d.messages),f=c.html(e);f.show()}}}});var cleanHTML=function(a){return a.replace(/[<>&\n]/g,function(a){return{"<":"&lt;",">":"&gt;","&":"&amp;","\n":"<br />"}[a]})};app.directive("tsDiscovery",function(){return{restrict:"E",templateUrl:"partials/discovery"}}),app.directive("tsChatMessage",function(){return{restrict:"E",templateUrl:"/partials/chatmessage"}}),app.directive("tsMediaBar",function(){return{restrict:"E",templateUrl:"/partials/mediabar"}}),angular.module("tsatter").controller("ChatController",["$timeout","$document","$location","$scope","socket","$rootScope","command","focus","$http","$anchorScroll","$q",function(a,b,c,d,e,f,g,h,i,j,k){function l(){g.send(["part",d.channelName])}function m(a){g.send(["mode",d.channelName,"+o",a[1]])}function n(a,b){var c=k.defer(),d=new Image;return d.onerror=function(){c.resolve([!1])},d.onload=function(){c.resolve([!0,a,b])},d.src=a,c.promise}d.messages=[],d.users=[],d.mediaList=[],d.glued=!0,d.mediaGlued=!0,d.nick="",d.editingNick=!1,d.infiniteBottomLocation=Number.MAX_VALUE,d.infiniteTopLocation=0,d.infiniteStep=20,d.infiniteReachedTop=!1,d.infiniteReachedBottom=!1,d.origin=location.origin,a(function(){p(d.channelName),d.nick=f.vars.nickname,d.getBacklog(),h("showChannel")}),d.currentlyHighlighted={},d.messageClicked=function(a){d.messages[a]["class"]="single-message-highlighted",d.currentlyHighlighted&&(d.currentlyHighlighted["class"]=""),d.currentlyHighlighted=d.messages[a]},d.getMessagesFromServer=function(a,b,c,d,e){i.get("/backlog/",{params:{channel:a,from:b,to:c}}).success(d).error(e)};var o=function(){console.log("error!")};d.getBacklog=function(){var b=c.hash(),e=-d.infiniteStep-1,f=-1;if(b){console.log("got hash: "+b);var g="#"+b.split("__")[0];if(g===d.channelName){var h=parseInt(b.split("__")[1]);f=parseInt(h+d.infiniteStep/2),e=parseInt(h-d.infiniteStep/2),0>=e&&(f+=-e,e=0,d.infiniteReachedTop=!0),d.glued=!1,d.infiniteBottomLocation=f,d.infiniteTopLocation=e}}else d.infiniteReachedBottom=!0;d.getMessagesFromServer(d.channelName,e,f,function(b){for(var e=0;e<b.length;e++)d.addBackendMessage(b[e]);a(function(){for(var a=c.hash(),b=0;b<d.messages.length;b++)if(d.messages[b].idx==a.split("__")[1]){d.currentlyHighlighted=d.messages[b],d.currentlyHighlighted["class"]="single-message-highlighted";break}j()}),0===b.length&&c.hash().length>1&&(console.log("message not found. do a flash message here?"),d.getBacklog(),d.glued=!0),b.length>0&&(d.infiniteBottomLocation=b[e-1].idx,d.infiniteTopLocation=b[0].idx),b.length<d.infiniteStep-1&&(d.infiniteReachedTop=!0,d.infiniteReachedBottom=!0)},o)},d.infiniteScrollDown=function(){d.infiniteReachedBottom||d.getMessagesFromServer(d.channelName,d.infiniteBottomLocation,d.infiniteBottomLocation+d.infiniteStep,function(b){if(0===b.length)return void(d.infiniteReachedBottom=!0);b.length<d.infiniteStep-1&&(d.infiniteReachedBottom=!0);var e=function(a){return function(){a-=10,0>a&&(a=0);var b=d.channelName.substring(1)+"__"+a;d.glued=!1,c.hash(b),j()}};a(e(d.infiniteBottomLocation)),d.infiniteBottomLocation+=b.length;for(var f=0;f<b.length;f++)d.addBackendMessage(b[f])},o)},d.infiniteScrollUp=function(){if(console.log("go up gfkjdsljdsfg"),d.infiniteReachedTop)return void console.log("already reached top");if(0===d.infiniteTopLocation)return void(d.infiniteReachedTop=!0);var b=d.infiniteTopLocation,e=b-d.infiniteStep;0>e&&(e=0,d.infiniteReachedTop=!0),d.getMessagesFromServer(d.channelName,e,b,function(b){if(0===b.length)return void(d.infiniteReachedTop=!0);b.length<d.infiniteStep-1&&(d.infiniteReachedTop=!0);var e=function(a){return function(){var b=d.channelName.substring(1)+"__"+a;d.glued=!1,c.hash(b),j()}};a(e(d.infiniteTopLocation)),console.log("other idx: "+d.infiniteTopLocation),d.infiniteTopLocation-=b.length,d.infiniteTopLocation<0&&(d.infiniteTopLocation=0);for(var f=b.length-1;f>=0;f--)d.addBackendMessage(b[f],!0)},o)},d.mediaCount=0;var p=function(a){d.$on(a,function(a,b){d.handler.hasOwnProperty(b.command)?d.handler[b.command](b):(console.log("no handler for:"),console.log(a),console.log(b))}),g.send("names "+a)};d.part=function(a){var b=d.users.indexOf(a.nick);0>b||(d.users.splice(b,1),d.infiniteReachedBottom&&d.addServerMessage(a.nick+" left the channel"))},d.names=function(a){d.users=Object.keys(a.nicks)},d.join=function(a){d.users.push(a.nick),d.infiniteReachedBottom&&d.addServerMessage(a.nick+" joined the channel")},d.privmsg=function(a){d.infiniteReachedBottom&&d.addMessage(a.args[1],a.nick)},d.nick=function(a){a.nick===d.nick&&(d.nick=a.args[0]);var b=d.users.indexOf(a.nick);d.users.splice(b,1,a.args[0]),d.infiniteReachedBottom&&d.addServerMessage(a.nick+" is now known as "+a.args[0])},d.quit=function(a){console.log("got quit");var b=d.users.indexOf(a.nick);0>b||(d.users.splice(b,1),d.infiniteReachedBottom&&d.addServerMessage(a.nick+" quit"))},d.errnick=function(a){d.infiniteReachedBottom&&d.addServerMessage(a.args[a.args.length-1])},d.nicknameinuse=function(a){d.infiniteReachedBottom&&d.addServerMessage(a.args[a.args.length-1])},d.activate=function(){a(function(){h("showChannel")})},d.handler={PRIVMSG:d.privmsg,JOIN:d.join,NAMES:d.names,PART:d.part,QUIT:d.quit,NICK:d.nick,err_erroneusnickname:d.errnick,err_nicknameinuse:d.nicknameinuse,activate:d.activate},d.addServerMessage=function(a){d.addMessage(a,"server")},d.addBackendMessage=function(a,b){d.addMessage(a.message,a.nick,a.timestamp,a.idx,b)},d.addMessage=function(a,b,c,e,f){var g={message:a,nick:b,timestamp:q(c),idx:e,"class":""};f?d.messages.unshift(g):d.messages.push(g);var h=t(a);if(h)for(var i=0;i<h.length;i++)n(h[i],g).then(function(a){var b=a[0];if(b){var c=a[1],e=a[2],f=d.mediaCount++;d.mediaList.push({url:c,idx:f}),e.message=e.message.replace(c,"["+f+"]")}})};var q=function(a){var b;return b=new Date(a?a:Date.now())},r={op:m,part:l};d.editNick=function(){d.editingNick=!0,h("editNick")},d.stopEditingNick=function(){d.editingNick=!1},d.ownNickAreaSubmit=function(){d.nick!==f.vars.nickname&&g.send(["nick",d.nick]),d.editingNick=!1,d.nick=f.vars.nickname},this.privmsg=function(){var a=d.message;if("undefined"!=typeof a)if(d.message="",0===a.indexOf("/")){0===a.indexOf("/")&&(a=a.substring(1));var b=a.split(" "),c=b[0].toLowerCase();r.hasOwnProperty(c)?r[c](b):g.send(a)}else{var h={channel:d.channelName,message:a};e.emit("privmsg",h),d.addMessage(a,f.vars.nickname)}},d.imgLoadedEvents={always:function(){d.mediaGlued=!d.mediaGlued,d.mediaGlued=!d.mediaGlued},fail:function(){console.log("fail")}};var s=/((((https?|ftp):\/\/)|www\.)(([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)|(([a-zA-Z0-9\-]+\.)*[a-zA-Z0-9\-]+\.(aero|asia|biz|cat|com|coop|info|int|jobs|mobi|museum|name|net|org|post|pro|tel|travel|xxx|edu|gov|mil|[a-zA-Z][a-zA-Z]))|([a-z]+[0-9]*))(:[0-9]+)?((\/|\?)[^ "]*[^ ,;\.:">)])?)|(spotify:[^ ]+:[^ ]+)/g,t=function(a){return a.match(s)}}]),angular.module("tsatter").controller("AllChatController",["$timeout","$rootScope","$scope","socket","command","$location",function(a,b,c,d,e,f){c.form={channel:""},c.userChannels=[],c.joinChannel=function(){var a=c.form.channel;return"#"===a||0===a.length?void(c.form.channel="Channel name should be at least 1 character long"):a.indexOf(" ")>=0?void(c.form.channel="No spaces in channel names allowed"):(0!==a.indexOf("#")&&(a="#"+a),e.send("join "+a),void(c.form.channel=""))},c.clickTab=function(a){c.$broadcast(a,{command:"activate"})},c.openLink=function(a){var b=a.split("__")[0];e.send("join #"+b)},c.$on("rpl_welcome",function(a,d){var e=f.hash();e&&c.openLink(e),f.absUrl().indexOf("#")<0&&f.hash("!"),b.vars.nickname=d.nick}),c.$on("err_erroneusnickname",function(a,b){c.sendToCurrentChannel(b)}),c.$on("err_nicknameinuse",function(a,b){c.sendToCurrentChannel(b)}),c.sendToCurrentChannel=function(a){for(var b=0;b<c.userChannels.length;b++)c.userChannels[b].active===!0&&c.$broadcast(c.userChannels[b].name,a)},c.$on("NICK",function(a,e){e.nick===b.vars.nickname&&(b.vars.nickname=e.args[0]);var f=d.getChannels();for(var g in f)f.hasOwnProperty(g)&&c.$broadcast(f[g],e)}),c.$on("JOIN",function(a,b){var d=b.args[0];c.addChannel(d)}),c.addChannel=function(a){for(var b=0;b<c.userChannels.length;b++)if(c.userChannels[b].name===a)return void(c.userChannels[b].active=!0);d.listenChannel(a),c.userChannels.push({name:a,active:!0})},c.leaveChannel=function(a){e.send(["part",a])},c.removeChannel=function(a){console.log("remove channel"),console.log(a);for(var b=0;b<c.userChannels.length;b++)if(c.userChannels[b].name===a){c.userChannels.splice(b,1);break}},c.$on("PART",function(a,b){c.removeChannel(b.args[0])}),c.$on("QUIT",function(a,b){console.log("got quit");var e=d.getChannels();for(var f in e)e.hasOwnProperty(f)&&c.$broadcast(e[f],b)}),b.vars={loggedIn:!1,nickname:"anon"}}]),angular.module("tsatter").controller("UserHeaderController",["$rootScope","$scope","socket",function(a,b){b.loginState=""}]),angular.module("tsatter").controller("DiscoveryController",["$scope","$http","command","$timeout",function(a,b,c,d){a.results=[],a.loaded=!1,a.infiniteSize=13,a.bottomLocation=0,a.reachedBottom=!1,a.loading=!1,a.getContent=function(c,d,e){b.get("/activity/",{params:{from:c,to:d}}).success(e).error(function(){console.log("error!"),a.loading=!1})},a.infiniteScrollDown=function(){if(!a.reachedBottom&&!a.loading){a.loading=!0;var b=a.bottomLocation,c=b+a.infiniteSize;a.getContent(b,c,function(e){a.results=a.results.concat(e),a.bottomLocation+=e.length,e.length<c-b-1&&(a.reachedBottom=!0),d(function(){a.loading=!1})})}},a.refresh=function(){a.loading=!0,a.reachedBottom=!1,a.bottomLocation=0;var b=0,c=a.infiniteSize;a.getContent(b,c,function(e){a.results=e,a.bottomLocation+=e.length,e.length<c-b-1&&(a.reachedBottom=!0),d(function(){a.loading=!1})})},a.joinChannel=function(b){c.send("join "+b),a.$emit("JOIN",{args:[b]})},a.refresh()}]),angular.module("tsatter").factory("socket",["$rootScope",function(a){var b=location.host,c=io(b);c.on("message",function(b){a.$apply(function(){a.$broadcast(b.command,b)})}),c.on("disconnect",function(){location.reload()}),c.on("reconnect",function(){location.reload()});var d=[];return{listenChannel:function(b){d.push(b),c.on(b,function(c){a.$apply(function(){a.$broadcast(b,c)})})},getChannels:function(){return d},emit:function(b,d,e){c.emit(b,d,function(){var b=arguments;a.$apply(function(){e&&e.apply(c,b)})})},send:function(a){c.send(a)}}}]),angular.module("tsatter").factory("command",["$rootScope","socket",function(a,b){return{send:function(a){"string"==typeof a&&(a=a.split(" ")),b.send({command:a})}}}]),app.factory("focus",["$rootScope","$timeout",function(a,b){return function(c){b(function(){a.$broadcast("focusOn",c)})}}]),app.directive("focusOn",function(){return function(a,b,c){a.$on("focusOn",function(a,d){d===c.focusOn&&b[0].focus()})}});